<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuarios - CineMax</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
    <style>
        .btn-action {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
<!-- NAVBAR -->
<nav class="navbar">
    <div class="logo">游꿟 CineMax</div>
    <ul class="nav-links">
        <li><a href="index.html">Inicio</a></li>
        <li><a href="peliculas.html">Pel칤culas</a></li>
        <li><a href="reservas.html">Reservas</a></li>
        <li><a href="usuarios.html">Usuarios</a></li>
    </ul>
</nav>

<!-- CONTENT -->
<div class="container">
    <div class="page-header">
        <h1>游논 Gesti칩n de Usuarios</h1>
        <button class="btn-add" onclick="openModal()">+ Agregar Usuario</button>
    </div>

    <!-- TABLA DE USUARIOS -->
    <div class="usuarios-table">
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Email</th>
                <th>Rol</th>
                <th>Acciones</th>
            </tr>
            </thead>
            <tbody id="usuariosBody"></tbody>
        </table>
    </div>
</div>

<!-- MODAL -->
<div id="modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Nuevo Usuario</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>

        <form id="usuarioForm">
            <input type="hidden" id="usuarioId">

            <div class="form-group">
                <label>Nombre</label>
                <input type="text" id="nombre" required>
            </div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" id="email" required>
            </div>

            <div class="form-group">
                <label>Contrase침a</label>
                <input type="password" id="password" required>
            </div>

            <div class="form-group">
                <label>Rol</label>
                <select id="rol" required>
                    <option value="USER">Usuario</option>
                    <option value="ADMIN">Administrador</option>
                </select>
            </div>

            <button type="submit" class="btn-add" style="width: 100%;">Guardar</button>
        </form>
    </div>
</div>

<script src="../assets/js/api.js"></script>
<script>
    let usuarios = [];

    // Cargar usuarios al iniciar
    window.addEventListener('DOMContentLoaded', cargarUsuarios);

    async function cargarUsuarios() {
        try {
            usuarios = await API.usuarios.getAll();
            console.log('Usuarios cargados:', usuarios);
            renderUsuarios();
        } catch (error) {
            console.error('Error cargando usuarios:', error);
            alert('Error al cargar usuarios: ' + error.message);
        }
    }

    function renderUsuarios() {
        const tbody = document.getElementById('usuariosBody');
        tbody.innerHTML = usuarios.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.nombre}</td>
                    <td>${u.email}</td>
                    <td><span class="badge badge-${u.rol === 'ADMIN' ? 'admin' : 'user'}">${u.rol}</span></td>
                    <td>
                        <button class="btn-action btn-edit" onclick="editarUsuario(${u.id})">Editar</button>
                        <button class="btn-action btn-delete" onclick="eliminarUsuario(${u.id})">Eliminar</button>
                    </td>
                </tr>
            `).join('');
    }

    function openModal(usuario = null) {
        const modal = document.getElementById('modal');
        const form = document.getElementById('usuarioForm');

        if (usuario) {
            document.getElementById('modalTitle').textContent = 'Editar Usuario';
            document.getElementById('usuarioId').value = usuario.id;
            document.getElementById('nombre').value = usuario.nombre;
            document.getElementById('email').value = usuario.email;
            document.getElementById('password').value = usuario.password;
            document.getElementById('rol').value = usuario.rol;
        } else {
            document.getElementById('modalTitle').textContent = 'Nuevo Usuario';
            form.reset();
            document.getElementById('usuarioId').value = '';
        }

        modal.style.display = 'block';
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    document.getElementById('usuarioForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const usuario = {
            nombre: document.getElementById('nombre').value,
            email: document.getElementById('email').value,
            password: document.getElementById('password').value,
            rol: document.getElementById('rol').value
        };

        const id = document.getElementById('usuarioId').value;

        console.log('Guardando usuario:', usuario);

        try {
            if (id) {
                const resultado = await API.usuarios.update(id, usuario);
                console.log('Usuario actualizado:', resultado);
                alert('Usuario actualizado exitosamente');
            } else {
                const resultado = await API.usuarios.create(usuario);
                console.log('Usuario creado:', resultado);
                alert('Usuario creado exitosamente');
            }

            closeModal();
            await cargarUsuarios();
        } catch (error) {
            console.error('Error completo:', error);
            alert('Error al guardar el usuario: ' + error.message);
        }
    });

    async function editarUsuario(id) {
        const usuario = usuarios.find(u => u.id === id);
        if (usuario) {
            openModal(usuario);
        }
    }

    async function eliminarUsuario(id) {
        if (confirm('쮼st치s seguro de eliminar este usuario?')) {
            try {
                await API.usuarios.delete(id);
                alert('Usuario eliminado exitosamente');
                await cargarUsuarios();
            } catch (error) {
                console.error('Error eliminando usuario:', error);
                alert('Error al eliminar el usuario: ' + error.message);
            }
        }
    }

    // Cerrar modal al hacer clic fuera
    window.onclick = function(event) {
        const modal = document.getElementById('modal');
        if (event.target === modal) {
            closeModal();
        }
    }
</script>
</body>
</html>
